# ----------------------------------------------------------------------------
# GitHub Action workflow to
#
# - test CGE compilation and automatic tests (using various FPC versions available in Docker)
# - pack CGE into zip (using only stable FPC, since our pack_release checks it)
#
# Uses CGE Docker image https://hub.docker.com/r/kambi/castle-engine-cloud-builds-tools/
# inside GH hosted runner.
#
# See https://docs.github.com/en/actions for docs.
# ----------------------------------------------------------------------------

name: Test And Pack (Docker)

# Called by everything.yml
on: [workflow_call]
#on: [push, pull_request]

defaults:
  run:
    shell: bash

jobs:
  pack_1:
    name: Pack to zip (1)

    # TODO: With Ubuntu 24 LTS, we hit weird "*** buffer overflow detected ***:"
    # from "zip -r castle-engine-7.0-alpha.3.snapshot-linux-x86_64.zip castle_game_engine/"
    # inside pack_release.sh .
    # Sample build: https://github.com/castle-engine/castle-engine/actions/runs/11084360353/job/30799583387
    #
    # Related somehow? https://bugzilla.redhat.com/show_bug.cgi?id=2165653
    # https://sourceforge.net/p/sevenzip/support-requests/581/
    #
    # Workaround by using Ubuntu 22 LTS for now.
    # Seehttps://github.com/actions/runner-images?tab=readme-ov-file .
    #runs-on: ubuntu-latest
    runs-on: ubuntu-22.04

    container: kambi/castle-engine-cloud-builds-tools:cge-none
    steps:
      - uses: actions/checkout@v4
      - name: Set environment
        run: echo "CASTLE_ENGINE_PATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV
      - name: Remove previous artifacts
        run: rm -f castle-engine*.zip

      - name: Pack Win64/x86_64
        run: ./tools/internal/pack_release/pack_release.sh win64 x86_64
      - name: Pack Linux/x86_64
        run: ./tools/internal/pack_release/pack_release.sh linux x86_64

      - name: Archive Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-and-linux-release-from-docker-1
          path: "castle-engine*.zip"
          if-no-files-found: error

  # We split pack into two jobs to avoid running out of disk space
  # on GH hosted runners, no other reason.
  pack_2:
    name: Pack to zip (2)
    # TODO: Just like above, workaround zip crashes by using older Ubuntu LTS.
    #runs-on: ubuntu-latest
    runs-on: ubuntu-22.04
    container: kambi/castle-engine-cloud-builds-tools:cge-none
    steps:
      - uses: actions/checkout@v4
      - name: Set environment
        run: echo "CASTLE_ENGINE_PATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Download bundled FPC
        uses: robinraju/release-downloader@v1.11
        with:
          repository: "castle-engine/cge-fpc"
          latest: true
          # Docs suggest we need a wildcard to get all files: https://github.com/marketplace/actions/release-downloader
          fileName: "*"
      - name: Pack With Bundled FPC for Win64/x86_64
        run: CGE_PACK_BUNDLE=yes ./tools/internal/pack_release/pack_release.sh win64 x86_64
      - name: Pack With Bundled FPC for Linux/x86_64
        run: CGE_PACK_BUNDLE=yes ./tools/internal/pack_release/pack_release.sh linux x86_64

      - name: Archive Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-and-linux-release-from-docker-2
          path: "castle-engine*.zip"
          if-no-files-found: error
